\begin{Verbatim}[commandchars=\\\{\},codes={\catcode`\$=3\catcode`\^=7\catcode`\_=8},fontsize=\small]
\PY{c}{(*}\PY{c}{ The state of SimpleNFS is a map from file handles}
\PY{c}{(}\PY{c}{inode numbers}\PY{c}{)}\PY{c}{ to contents }\PY{c}{(}\PY{c}{list of bytes}\PY{c}{)}\PY{c}{. }\PY{c}{*)}
\PY{k+kn}{Definition} \PY{n}{State} \PY{o}{:=} \PY{n}{gmap} \PY{n}{fh} \PY{o}{(}\PY{n}{list} \PY{n}{u8}\PY{o}{)}\PY{o}{.}

\PY{k+kn}{Definition} \PY{n}{write} \PY{o}{(}\PY{n}{f} \PY{o}{:} \PY{n}{fh}\PY{o}{)} \PY{o}{(}\PY{n}{off} \PY{o}{:} \PY{n}{u64}\PY{o}{)}
           \PY{o}{(}\PY{n}{d} \PY{o}{:} \PY{n}{list} \PY{n}{u8}\PY{o}{)} \PY{o}{(}\PY{n}{d0} \PY{o}{:} \PY{n}{list} \PY{n}{u8}\PY{o}{)}
    \PY{o}{:} \PY{n}{transition} \PY{n}{State} \PY{n}{u32} \PY{o}{:=}
  \PY{c}{(*}\PY{c}{ Convert u64 to mathematical integer }\PY{c}{*)}
  \PY{k}{let} \PY{n}{off} \PY{o}{:=} \PY{n}{int}\PY{o}{.}\PY{n}{nat} \PY{n}{off} \PY{k}{in}
  \PY{c}{(*}\PY{c}{ Simplified spec does not allow creating holes,}
\PY{c}{     but does allow appending }\PY{c}{*)}
  \PY{n}{check} \PY{o}{(}\PY{n}{off} â‰¤ \PY{n}{length} \PY{n}{d0}\PY{o}{)}\PY{o}{;}
  \PY{k}{let} \PY{n}{d\PYZsq{}} \PY{o}{:=} \PY{n}{d0}\PY{o}{[}\PY{o}{:}\PY{n}{off}\PY{o}{]} \PY{o}{+}\PY{o}{+} \PY{n}{d} \PY{o}{+}\PY{o}{+} \PY{n}{d0}\PY{o}{[}\PY{n}{off}\PY{o}{+}\PY{n}{length} \PY{n}{d}\PY{o}{:}\PY{o}{]} \PY{k}{in}
  \PY{c}{(*}\PY{c}{ Update spec file state }\PY{c}{*)}
  \PY{n}{modify} \PY{o}{(}\PY{k}{fun} \PY{n}{s} \PY{o}{=\PYZgt{}} \PY{n}{insert} \PY{n}{f} \PY{n}{d\PYZsq{}} \PY{n}{s}\PY{o}{)}\PY{o}{;}
  \PY{n}{ret} \PY{o}{(}\PY{n}{U32} \PY{o}{(}\PY{n}{length} \PY{n}{d}\PY{o}{)}\PY{o}{)}\PY{o}{.}
\end{Verbatim}
