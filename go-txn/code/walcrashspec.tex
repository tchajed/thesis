\begin{Verbatim}[commandchars=\\\{\},codes={\catcode`\$=3\catcode`\^=7\catcode`\_=8},fontsize=\small]
\PY{k+kn}{Record} \PY{n}{update} \PY{o}{:=} \PY{o}{\PYZob{}} \PY{n}{addr}\PY{o}{:} \PY{n}{u64}\PY{o}{;} \PY{n}{data}\PY{o}{:} \PY{n}{Block}\PY{o}{;} \PY{o}{\PYZcb{}}\PY{o}{.}
\PY{k+kn}{Record} \PY{n}{State} \PY{o}{:=}
  \PY{o}{\PYZob{}} \PY{n}{multiwrites}\PY{o}{:} \PY{n}{list} \PY{o}{(}\PY{n}{list} \PY{n}{update}\PY{o}{)}\PY{o}{;}
    \PY{c}{(*}\PY{c}{ at least durable\PYZus{}lb elements are durable }\PY{c}{*)}
    \PY{n}{durable\PYZus{}lb}\PY{o}{:} \PY{n}{nat}\PY{o}{;} \PY{o}{\PYZcb{}}\PY{o}{.}

\PY{k+kn}{Definition} \PY{n}{mem\PYZus{}append} \PY{o}{(}\PY{n}{ws}\PY{o}{:} \PY{n}{list} \PY{n}{update}\PY{o}{)} \PY{o}{:}
    \PY{n}{transition} \PY{n}{State} \PY{n}{unit} \PY{o}{:=}
  \PY{n}{modify} \PY{o}{(}\PY{k}{set} \PY{n}{multwrites} \PY{o}{(}\PY{k}{fun} \PY{n}{l} \PY{o}{=\PYZgt{}} \PY{n}{l} \PY{o}{+}\PY{o}{+} \PY{o}{[}\PY{n}{ws}\PY{o}{]}\PY{o}{)}\PY{o}{)}\PY{o}{;}
  \PY{n}{ret} \PY{n}{tt}\PY{o}{.}

\PY{c}{(*}\PY{c}{ non\PYZhy{}deterministically pick how many}
\PY{c}{   multiwrites survive the crash. }\PY{c}{*)}
\PY{k+kn}{Definition} \PY{n}{crash} \PY{o}{:} \PY{n}{transition} \PY{n}{State} \PY{n}{unit} \PY{o}{:=}
  \PY{n}{durable} \PY{o}{\PYZlt{}\PYZhy{}} \PY{n}{suchThat} \PY{o}{(}\PY{k}{fun} \PY{n}{s} \PY{n}{i} \PY{o}{=\PYZgt{}} \PY{n}{durable\PYZus{}lb} \PY{n}{s} â‰¤ \PY{n}{i}\PY{o}{)}\PY{o}{;}
  \PY{n}{modify} \PY{o}{(}\PY{k}{set} \PY{n}{multiwrites} \PY{o}{(}\PY{k}{fun} \PY{n}{l} \PY{o}{=\PYZgt{}} \PY{n}{l}\PY{o}{[}\PY{o}{:}\PY{n}{durable}\PY{o}{]}\PY{o}{)}\PY{o}{)}\PY{o}{;}
  \PY{n}{modify} \PY{o}{(}\PY{k}{set} \PY{n}{durable\PYZus{}lb} \PY{o}{(}\PY{k}{fun} \PY{o}{\PYZus{}} \PY{o}{=\PYZgt{}} \PY{n}{durable}\PY{o}{)}\PY{o}{)}\PY{o}{;}
  \PY{n}{ret} \PY{n}{tt}\PY{o}{.}
\end{Verbatim}
